<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Summariser">
    <link rel="apple-touch-icon" href="icon.png">
    <title>AI News Summarizer - Setup Your Provider</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="icon.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #1a1a1a;
        }

        .container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #4F46E5, #06B6D4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.1rem;
            color: #666;
        }

        .value-prop {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 10px;
            margin: 2rem 0;
            text-align: left;
        }

        .value-prop h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .value-prop ul {
            list-style: none;
            padding-left: 0;
        }

        .value-prop li {
            display: flex;
            align-items: center;
            margin-bottom: 0.8rem;
            color: #475569;
        }

        .value-prop li::before {
            content: "âœ“";
            color: #10b981;
            font-weight: bold;
            margin-right: 0.8rem;
        }

        .security-notice {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0 2rem;
            text-align: left;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .security-notice svg {
            flex-shrink: 0;
            color: #3b82f6;
            margin-top: 0.15rem;
        }

        .security-notice p {
            color: #1e40af;
            margin: 0;
            font-size: 0.95rem;
        }

        .security-notice a {
            color: #2563eb;
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
        }

        .provider-list {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .provider-option {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: left;
        }

        .provider-option:hover {
            border-color: #4F46E5;
            transform: translateY(-2px);
        }

        .provider-option.selected {
            border-color: #4F46E5;
            background: #f8fafc;
        }

        .provider-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .provider-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }

        .signup-link {
            display: inline-block;
            background: #4F46E5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .signup-link:hover {
            background: #4338ca;
        }

        .provider-description {
            color: #64748b;
            margin-bottom: 1rem;
        }

        .api-fields {
            display: none;
            margin-top: 1rem;
        }

        .provider-option.selected .api-fields {
            display: block;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #334155;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
        }

        .input-group .hint {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #64748b;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 0.5rem;
            transform: scale(1.2);
        }

        .checkbox-group label {
            font-size: 0.9rem;
            color: #475569;
            cursor: pointer;
        }

        .recovery-fields {
            display: none;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .recovery-fields.visible {
            display: block;
        }

        .install-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 2rem;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .install-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .install-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            display: none;
            background: #ecfdf5;
            color: #047857;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: center;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: #1e293b;
            margin: 0;
            text-align: left;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: #1e293b;
        }

        .step-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .step-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .step-item:last-child {
            margin-bottom: 0;
        }

        .step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #4F46E5;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-content h3 {
            font-size: 1.1rem;
            color: #1e293b;
            margin: 0 0 0.5rem 0;
        }

        .step-content p {
            color: #64748b;
            margin: 0;
            line-height: 1.5;
        }

        .step-content code {
            background: #f1f5f9;
            border-radius: 4px;
            padding: 0.15rem 0.3rem;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .security-modal {
            max-width: 650px;
        }

        .modal-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .provider-steps h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
            color: #1e293b;
        }

        .modal-footer {
            margin-top: 2rem;
            text-align: center;
        }

        .understand-button {
            background: #4F46E5;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .understand-button:hover {
            background: #4338ca;
        }

        /* Recovery modal */
        .recovery-modal-content {
            max-width: 550px;
        }

        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .step-item {
                gap: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI News Summarizer</h1>
            <p>Your personal AI-powered news digest assistant</p>
        </div>

        <div class="value-prop">
            <h2>Why Choose Our Summarizer?</h2>
            <ul>
                <li>Instantly summarize news articles from Google News</li>
                <li>Choose from leading AI providers for best results</li>
                <li>Works offline after installation</li>
                <li>Seamless sharing from your mobile device</li>
            </ul>
        </div>

        <div class="security-notice">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
            <p>
                <strong>Enhanced Security:</strong> Your API keys are automatically encrypted using device-specific binding. For added safety, you can now <a href="#" onclick="showRecoveryModal(); return false;">create a recovery key</a> that works across devices.
            </p>
        </div>

        <h2 style="margin-bottom: 1rem; color: #1e293b;">Choose Your AI Provider</h2>
        <p style="color: #64748b; margin-bottom: 2rem;">Select an AI provider and get your API key to start summarizing articles</p>

        <div class="provider-list">
            <div class="provider-option" data-provider="openai">
                <div class="provider-header">
                    <span class="provider-name">OpenAI</span>
                    <a href="https://platform.openai.com/signup" target="_blank" class="signup-link">Get API Key</a>
                </div>
                <div class="provider-description">
                    Use GPT-4 or GPT-3.5-turbo for high-quality summaries. Best for comprehensive and accurate results.
                </div>
                <div class="api-fields">
                    <div class="input-group">
                        <label for="openai-key">API Key</label>
                        <input type="password" id="openai-key" placeholder="sk-...">
                        <span class="hint">Your API key is securely encrypted for this device only</span>
                    </div>
                    <div class="input-group">
                        <label for="openai-model">Model</label>
                        <select id="openai-model">
                            <option value="gpt-4">GPT-4 (Most Accurate)</option>
                            <option value="gpt-3.5-turbo" selected>GPT-3.5-Turbo (Faster)</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="openai-recovery" class="enable-recovery">
                        <label for="openai-recovery">Enable recovery key (optional but recommended)</label>
                    </div>
                    <div class="recovery-fields" id="openai-recovery-fields">
                        <div class="input-group">
                            <label for="openai-recovery-pin">Recovery PIN (4-6 digits)</label>
                            <input type="password" id="openai-recovery-pin" placeholder="Create a PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                            <span class="hint">This PIN will let you recover your API key on a new device</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="provider-option" data-provider="anthropic">
                <div class="provider-header">
                    <span class="provider-name">Anthropic Claude</span>
                    <a href="https://console.anthropic.com/signup" target="_blank" class="signup-link">Get API Key</a>
                </div>
                <div class="provider-description">
                    Use Claude 3 for articulate and nuanced summaries. Excellent for understanding complex topics.
                </div>
                <div class="api-fields">
                    <div class="input-group">
                        <label for="anthropic-key">API Key</label>
                        <input type="password" id="anthropic-key" placeholder="sk-ant-...">
                        <span class="hint">Your API key is securely encrypted for this device only</span>
                    </div>
                    <div class="input-group">
                        <label for="anthropic-model">Model</label>
                        <select id="anthropic-model">
                            <option value="claude-3-opus-20240229">Claude 3 Opus (Most Capable)</option>
                            <option value="claude-3-sonnet-20240229" selected>Claude 3 Sonnet (Balanced)</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="anthropic-recovery" class="enable-recovery">
                        <label for="anthropic-recovery">Enable recovery key (optional but recommended)</label>
                    </div>
                    <div class="recovery-fields" id="anthropic-recovery-fields">
                        <div class="input-group">
                            <label for="anthropic-recovery-pin">Recovery PIN (4-6 digits)</label>
                            <input type="password" id="anthropic-recovery-pin" placeholder="Create a PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                            <span class="hint">This PIN will let you recover your API key on a new device</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="provider-option" data-provider="deepseek">
                <div class="provider-header">
                    <span class="provider-name">DeepSeek</span>
                    <a href="https://platform.deepseek.com/signup" target="_blank" class="signup-link">Get API Key</a>
                </div>
                <div class="provider-description">
                    Cost-effective open source alternative for quick summaries. Good balance of quality and price.
                </div>
                <div class="api-fields">
                    <div class="input-group">
                        <label for="deepseek-key">API Key</label>
                        <input type="password" id="deepseek-key" placeholder="API Key...">
                        <span class="hint">Your API key is securely encrypted for this device only</span>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="deepseek-recovery" class="enable-recovery">
                        <label for="deepseek-recovery">Enable recovery key (optional but recommended)</label>
                    </div>
                    <div class="recovery-fields" id="deepseek-recovery-fields">
                        <div class="input-group">
                            <label for="deepseek-recovery-pin">Recovery PIN (4-6 digits)</label>
                            <input type="password" id="deepseek-recovery-pin" placeholder="Create a PIN" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                            <span class="hint">This PIN will let you recover your API key on a new device</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="install-button" id="installButton" disabled>Configure & Install PWA</button>
        <div class="success-message" id="successMessage">
            âœ“ Configuration saved successfully! You can now share articles from Google News to get AI summaries.
        </div>
    </div>

    <!-- Installation Instructions Modal -->
    <div class="modal-overlay" id="instructionsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('instructionsModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸŽ‰ Setup Complete!</h2>
            </div>
            <ul class="step-list">
                <li class="step-item">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <h3>Install the App</h3>
                        <p>Click the three dots menu (â‹®) in your browser â†’ Select "Add to Home Screen" â†’ Confirm installation</p>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <h3>Open Google News</h3>
                        <p>Browse any article in Google News or Google Discover that you want to summarize</p>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <h3>Share the Article</h3>
                        <p>Tap the Share button â†’ Select "Summarise with AI" from the share menu</p>
                    </div>
                </li>
                <li class="step-item">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <h3>Get Your Summary</h3>
                        <p>The AI will process the article and show you a concise summary in seconds!</p>
                    </div>
                </li>
            </ul>
            <div class="modal-footer">
                <button class="understand-button" onclick="closeModalAndRedirect()">I Understand</button>
            </div>
        </div>
    </div>

    <!-- Recovery Key Explanation Modal -->
    <div class="modal-overlay" id="recoveryModal">
        <div class="modal-content recovery-modal-content">
            <button class="modal-close" onclick="closeModal('recoveryModal')">&times;</button>
            <div class="modal-header">
                <h2>ðŸ”‘ Recovery Key System</h2>
            </div>
            <div class="modal-section">
                <h3>Why Use a Recovery Key?</h3>
                <p style="margin-bottom: 1rem; color: #475569;">
                    Our app uses device-specific encryption to protect your API keys. While this is secure, it means 
                    your keys are locked to this device. If your browser updates or you switch devices, you might lose 
                    access to your API keys.
                </p>
                <p style="color: #475569;">
                    A recovery PIN provides a way to access your API keys even when the device signature changes, 
                    without compromising security.
                </p>
            </div>
            <div class="modal-section">
                <h3>How It Works</h3>
                <ul class="step-list">
                    <li class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Create a PIN</h3>
                            <p>Set a 4-6 digit PIN when configuring your API provider</p>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>We Create a Recovery Key</h3>
                            <p>Your API key is encrypted with both your device signature and your PIN</p>
                        </div>
                    </li>
                    <li class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>If Device Changes</h3>
                            <p>When you need to recover, enter your PIN and we'll restore your API key</p>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="understand-button" onclick="closeModal('recoveryModal')">I Understand</button>
            </div>
        </div>
    </div>

    <script>
        let selectedProvider = null;
        const appDomain = window.location.hostname || 'ays-0908.github.io';
        
        // Security utility functions for API key encryption/decryption
        // These functions encrypt API keys with device-specific information
        
        /**
         * Generates a unique device signature using device and browser information
         * @returns {string} A unique string for the current device
         */
        function generateDeviceSignature() {
            const domain = window.location.hostname || 'ays-0908.github.io';
            const browserInfo = navigator.userAgent;
            const screenInfo = `${window.screen.width}x${window.screen.height}`;
            const languageInfo = navigator.language;
            const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Combine various device signals for a unique signature
            return `${domain}-${browserInfo}-${screenInfo}-${languageInfo}-${timeZone}`;
        }
        
        /**
         * Creates a hash from a string
         * @param {string} str - String to hash
         * @returns {string} - Hashed value
         */
        function stringToHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32-bit integer
            }
            return hash.toString(16); // Convert to hex string
        }
        
        /**
         * Encrypts a string using XOR with a key
         * @param {string} text - Text to encrypt
         * @param {string} key - Encryption key
         * @returns {string} - Base64 encoded encrypted string
         */
        function encryptString(text, key) {
            if (!text) return '';
            
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                result += String.fromCharCode(charCode);
            }
            // Base64 encode for safer storage
            return btoa(result);
        }
        
        /**
         * Decrypts a previously encrypted string
         * @param {string} encryptedText - Base64 encoded encrypted string
         * @param {string} key - Decryption key (same as encryption key)
         * @returns {string} - Original string
         */
        function decryptString(encryptedText, key) {
            if (!encryptedText) return '';
            try {
                const encryptedBytes = atob(encryptedText);
                let result = '';
                for (let i = 0; i < encryptedBytes.length; i++) {
                    const charCode = encryptedBytes.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    result += String.fromCharCode(charCode);
                }
                return result;
            } catch (e) {
                console.error('Decryption failed:', e);
                return '';
            }
        }
        
        /**
         * Creates a validation hash for recovery verification
         * @param {string} apiKey - The API key 
         * @param {string} pin - Recovery PIN
         * @returns {string} - Validation hash
         */
        function createValidationHash(apiKey, pin) {
            // Create a hash that can verify the PIN is correct for this API key
            // but doesn't expose the API key itself
            const combined = apiKey.substring(0, 4) + pin + apiKey.substring(apiKey.length - 4);
            return stringToHash(combined);
        }
        
        /**
         * Secure API key storage with device binding and optional recovery
         * @param {string} apiKey - API key to securely store
         * @param {string} provider - AI Provider name
         * @param {string} model - Selected model
         * @param {string|null} recoveryPin - Optional recovery PIN
         */
        function securelyStoreApiKey(apiKey, provider, model, recoveryPin = null) {
            // Generate device-specific encryption key
            const deviceSignature = generateDeviceSignature();
            const deviceKey = stringToHash(deviceSignature);
            
            // Encrypt the API key with device signature
            const encryptedKey = encryptString(apiKey, deviceKey);
            
            // Create the configuration object
            const config = {
                provider: provider,
                model: model,
                encryptedKey: encryptedKey,
                securityVersion: 2, // Updated version for recovery support
                lastUpdated: new Date().toISOString()
            };
            
            // If recovery PIN is provided, add recovery information
            if (recoveryPin && recoveryPin.length >= 4) {
                // Create a secondary encryption using the PIN
                const recoveryEncryptedKey = encryptString(apiKey, recoveryPin);
                
                // Store validation hash to verify correct PIN without exposing the key
                const validationHash = createValidationHash(apiKey, recoveryPin);
                
                // Add recovery information to config
                config.recovery = {
                    enabled: true,
                    encryptedKey: recoveryEncryptedKey,
                    validationHash: validationHash,
                    // We don't store the PIN itself for security
                };
            }
            
            // Store the config
            localStorage.setItem('ai_summarizer_config', JSON.stringify(config));
        }
        
        /**
         * Retrieves and decrypts an API key
         * @returns {string|null} - Decrypted API key or null if not found/decryptable
         */
        function retrieveApiKey() {
            const config = JSON.parse(localStorage.getItem('ai_summarizer_config'));
            if (!config || !config.encryptedKey) return null;
            
            // Recreate device signature for decryption
            const deviceSignature = generateDeviceSignature();
            const deviceKey = stringToHash(deviceSignature);
            
            // Try to decrypt API key with device signature
            const apiKey = decryptString(config.encryptedKey, deviceKey);
            
            // If successful, return the API key
            if (apiKey && apiKey.length > 10) {
                return apiKey;
            }
            
            return null;
        }

        /**
         * Show the recovery modal
         */
        function showRecoveryModal() {
            document.getElementById('recoveryModal').classList.add('active');
        }

        /**
         * Toggle recovery field visibility
         * @param {string} providerId - Provider ID
         */
        function toggleRecoveryFields(providerId) {
            const checkbox = document.getElementById(`${providerId}-recovery`);
            const fields = document.getElementById(`${providerId}-recovery-fields`);
            
            if (checkbox.checked) {
                fields.classList.add('visible');
            } else {
                fields.classList.remove('visible');
            }
        }

        // Check for existing configuration and pre-fill form
        function loadExistingConfig() {
            const existingConfig = localStorage.getItem('ai_summarizer_config');
            if (existingConfig) {
                const config = JSON.parse(existingConfig);
                selectedProvider = config.provider;
                
                // Get decrypted API key if available
                let apiKey = '';
                if (config.encryptedKey) {
                    const deviceSignature = generateDeviceSignature();
                    const deviceKey = stringToHash(deviceSignature);
                    apiKey = decryptString(config.encryptedKey, deviceKey);
                } else if (config.apiKey) {
                    // Legacy support for old format
                    apiKey = config.apiKey;
                }

                // Select the correct provider option
                const providerOption = document.querySelector(`[data-provider="${config.provider}"]`);
                if (providerOption) {
                    providerOption.classList.add('selected');
                    
                    // Pre-fill API key
                    const apiKeyInput = providerOption.querySelector('input[type="password"]');
                    if (apiKeyInput && apiKey) {
                        apiKeyInput.value = apiKey;
                    }
                    
                    // Pre-select model if applicable
                    const modelSelect = providerOption.querySelector('select');
                    if (modelSelect && config.model) {
                        modelSelect.value = config.model;
                    }
                    
                    // Check recovery checkbox if enabled
                    if (config.recovery && config.recovery.enabled) {
                        const recoveryCheckbox = document.getElementById(`${config.provider}-recovery`);
                        if (recoveryCheckbox) {
                            recoveryCheckbox.checked = true;
                            toggleRecoveryFields(config.provider);
                        }
                    }
                    
                    // Enable install button
                    document.getElementById('installButton').disabled = !apiKey;
                    document.getElementById('installButton').textContent = 'Update Configuration';
                }
            }
        }

        // Show the instructions modal
        function showModal() {
            document.getElementById('instructionsModal').classList.add('active');
        }

        // Close the specified modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal and redirect to main app
        function closeModalAndRedirect() {
            closeModal('instructionsModal');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }

        // Handle provider selection
        document.querySelectorAll('.provider-option').forEach(option => {
            option.addEventListener('click', () => {
                // Clear previous selection
                document.querySelectorAll('.provider-option').forEach(o => o.classList.remove('selected'));
                
                // Select new provider
                option.classList.add('selected');
                selectedProvider = option.dataset.provider;
                
                // Enable install button if API key is filled
                const apiKeyInput = option.querySelector('input[type="password"]');
                document.getElementById('installButton').disabled = !apiKeyInput.value;
                
                apiKeyInput.addEventListener('input', () => {
                    document.getElementById('installButton').disabled = !apiKeyInput.value;
                });
            });
        });

        // Handle installation
        document.getElementById('installButton').addEventListener('click', async () => {
            if (!selectedProvider) return;

            const providerOption = document.querySelector(`[data-provider="${selectedProvider}"]`);
            const apiKey = providerOption.querySelector('input[type="password"]').value;
            const modelSelect = providerOption.querySelector('select');
            const model = modelSelect ? modelSelect.value : null;

            // Check if recovery is enabled
            const recoveryCheckbox = document.getElementById(`${selectedProvider}-recovery`);
            let recoveryPin = null;
            
            if (recoveryCheckbox && recoveryCheckbox.checked) {
                const recoveryPinInput = document.getElementById(`${selectedProvider}-recovery-pin`);
                if (recoveryPinInput && recoveryPinInput.value.length >= 4) {
                    recoveryPin = recoveryPinInput.value;
                }
            }

            // Save configuration with encrypted API key and optional recovery
            securelyStoreApiKey(apiKey, selectedProvider, model, recoveryPin);

            // Show success message and instructions modal
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('installButton').disabled = true;
            document.getElementById('installButton').textContent = 'Configuration Saved!';

            // Show the instructions modal after a short delay
            setTimeout(() => {
                showModal();
            }, 1000);
        });

        // Setup recovery checkbox handlers
        document.querySelectorAll('.enable-recovery').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const providerId = checkbox.id.split('-')[0];
                toggleRecoveryFields(providerId);
            });
        });

        // Load existing configuration when page loads
        window.addEventListener('load', loadExistingConfig);
    </script>
</body>
</html>